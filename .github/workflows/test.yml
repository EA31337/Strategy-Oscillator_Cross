---
name: Test

# yamllint disable-line rule:truthy
on:
  pull_request:
    branches:
      - 'master'
      - '*dev*'
    paths-ignore:
      - '*.md'
  push:
    branches:
      - 'master'
      - '*dev*'
    paths-ignore:
      - '*.md'

jobs:

  compile:
    name: Compile
    uses: ./.github/workflows/compile.yml

  test:
    name: Test
    needs: compile
    runs-on: ubuntu-latest
    strategy:
      matrix:
        strategy:
          - Oscillator_Cross
        year: [2022, 2024]
        version: [5]
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          pattern: Strategy-${{ matrix.strategy }}-ex${{ matrix.version }}

      - name: List compiled files
        run: find . -name '*.ex?' -type f -print

      - name: Test ${{ matrix.year }}
        uses: fx31337/mql-tester-action@master
        with:
          Login: ${{ secrets.MT5_LOGIN }}
          Password: ${{ secrets.MT5_PASSWORD }}
          Server: MetaQuotes-Demo
          TestDeposit: 2000
          TestExpert: Stg_${{ matrix.strategy }}.ex5
          TestFromDate: ${{ matrix.year }}.01.01
          TestPeriod: M1
          TestSymbol: EURUSD
          TestToDate: ${{ matrix.year }}.01.14
          # yamllint disable-line rule:line-length
          UrlExpert: file://${{ github.workspace }}/${{ matrix.strategy }}/Stg_${{ matrix.strategy }}.ex5
          Version: 5
